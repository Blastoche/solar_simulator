{% extends "base.html" %}
{% load static %}

{% block title %}D√©tails - Calculateur de Consommation{% endblock %}

{% block content %}
<!-- Plotly charg√© ici pour √™tre s√ªr -->
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

<div class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 py-12">
    <div class="max-w-6xl mx-auto px-4">
        
        <!-- En-t√™te -->
        <div class="mb-8">
            <a href="{% url 'frontend:consumption_result' consommation.id %}" 
               class="inline-flex items-center text-purple-600 hover:text-purple-800 font-semibold mb-4">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Retour au r√©sum√©
            </a>
            <h1 class="text-4xl font-bold text-gray-900">
                üìä Analyse D√©taill√©e
            </h1>
            <p class="text-lg text-gray-600 mt-2">
                Consommation annuelle : <span class="font-bold text-purple-600">{{ consommation.consommation_annuelle_totale|floatformat:0 }} kWh</span>
            </p>
        </div>
        
        <!-- Tableau d√©taill√© par poste (MODIFI√â V2) -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gradient-to-r from-purple-600 to-blue-600">
                <h2 class="text-2xl font-bold text-white">
                    üîå R√©partition d√©taill√©e par poste
                </h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poste</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">kWh/an</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">% du total</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‚Ç¨/an</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for poste, data in consommation.repartition_postes.items %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-semibold text-gray-900">
                                    {% if poste == 'chauffage' %}üî• Chauffage
                                    {% elif poste == 'ecs' %}üöø Eau chaude sanitaire
                                    {% elif poste == 'electromenager' %}üß∫ √âlectrom√©nager
                                    {% elif poste == 'cuisson' %}üç≥ Cuisson
                                    {% elif poste == 'audiovisuel' %}üì∫ Audiovisuel
                                    {% elif poste == 'eclairage' %}üí° √âclairage
                                    {% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900">
                                {{ data.kwh|floatformat:0 }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                    {{ data.pourcentage }}%
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-700 font-semibold">
                                {% if financier %}
                                    {% if financier.type == 'base' %}
                                        {% widthratio data.kwh 1 financier.prix_moyen_kwh %}
                                    {% else %}
                                        ~{% widthratio data.kwh 1 0.24 %}
                                    {% endif %}
                                {% else %}
                                    {% widthratio data.kwh 1 0.2516 %}
                                {% endif %} ‚Ç¨
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="bg-gray-100 font-bold">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">TOTAL</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                {{ consommation.consommation_annuelle_totale|floatformat:0 }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                100%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                                {% if financier %}
                                    {{ financier.cout_total|floatformat:2 }}
                                {% else %}
                                    {% widthratio consommation.consommation_annuelle_totale 1 0.2516 %}
                                {% endif %} ‚Ç¨
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            {% if financier %}
            <div class="px-6 py-3 bg-gray-50 text-xs text-gray-600 text-center border-t">
                {% if financier.type == 'base' %}
                Prix moyen : {{ financier.prix_moyen_kwh }} ‚Ç¨/kWh ‚Ä¢ Abonnement {{ financier.puissance }} : {{ financier.abonnement|floatformat:2 }}‚Ç¨/an
                {% elif financier.type == 'hphc' %}
                Tarif HP/HC ‚Ä¢ HP: {{ financier.prix_hp }}‚Ç¨/kWh ‚Ä¢ HC: {{ financier.prix_hc }}‚Ç¨/kWh ‚Ä¢ Abonnement {{ financier.puissance }} : {{ financier.abonnement|floatformat:2 }}‚Ç¨/an
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Param√®tres techniques -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                ‚öôÔ∏è Vos param√®tres
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">üè† Logement</h3>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p>Surface : <span class="font-semibold text-gray-900">{{ consommation.surface_habitable|floatformat:0 }} m¬≤</span></p>
                        <p>Personnes : <span class="font-semibold text-gray-900">{{ consommation.nb_personnes }}</span></p>
                        <p>DPE : <span class="font-semibold text-gray-900">{{ consommation.dpe }}</span></p>
                        <p>Zone : <span class="font-semibold text-gray-900">{{ consommation.zone_climatique }}</span></p>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">üî• Chauffage</h3>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p>Type : <span class="font-semibold text-gray-900">{{ consommation.type_chauffage|title }}</span></p>
                        <p>Temp√©rature : <span class="font-semibold text-gray-900">{{ consommation.temperature_consigne }}¬∞C</span></p>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">‚ö° Contrat</h3>
                    <div class="space-y-1 text-sm text-gray-600">
                        {% if financier %}
                        <p>Puissance : <span class="font-semibold text-gray-900">{{ financier.puissance }}</span></p>
                        <p>Type : <span class="font-semibold text-gray-900">
                            {% if financier.type == 'base' %}Base{% else %}HP/HC{% endif %}
                        </span></p>
                        {% else %}
                        <p>Puissance : <span class="font-semibold text-gray-900">6 kVA (d√©faut)</span></p>
                        <p>Type : <span class="font-semibold text-gray-900">Base</span></p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graphiques -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Graphique consommation mensuelle -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üìÖ Consommation mensuelle</h3>
                <div id="monthly-chart" style="width:100%; height:400px;"></div>
            </div>
            
            <!-- Graphique r√©partition par poste -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ü•ß R√©partition par poste</h3>
                <div id="pie-chart" style="width:100%; height:400px;"></div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-lg p-6 no-print">
            <h3 class="text-xl font-bold text-gray-900 mb-4">üì• Exporter vos r√©sultats</h3>
            
            <div class="flex flex-wrap gap-4">
                <button onclick="window.print()" 
                        class="inline-flex items-center px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-print mr-2"></i>
                    Imprimer / PDF
                </button>
            </div>
        </div>
        
    </div>
</div>

<script>
// Logs de debug
console.log('üîç Script Plotly d√©marr√©');
console.log('Plotly disponible ?', typeof Plotly !== 'undefined');

// Graphique 1 : Consommation mensuelle
const monthlyData = {{ consommation.consommation_mensuelle|safe }};
console.log('üìä Donn√©es mensuelles:', monthlyData);

const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];

const monthlyTrace = {
    x: months,
    y: monthlyData,
    type: 'bar',
    marker: {
        color: monthlyData,
        colorscale: [
            [0, '#3b82f6'],
            [0.5, '#8b5cf6'],
            [1, '#ec4899']
        ],
        line: {
            color: '#1e293b',
            width: 1
        }
    },
    text: monthlyData.map(v => v.toFixed(0) + ' kWh'),
    textposition: 'outside',
    hovertemplate: '<b>%{x}</b><br>%{y:.0f} kWh<extra></extra>'
};

const monthlyLayout = {
    title: {
        text: '',
        font: { size: 16, color: '#1f2937' }
    },
    xaxis: {
        title: '',
        showgrid: false
    },
    yaxis: {
        title: 'kWh',
        showgrid: true,
        gridcolor: '#e5e7eb'
    },
    plot_bgcolor: '#f9fafb',
    paper_bgcolor: 'white',
    margin: { t: 20, r: 20, b: 40, l: 60 },
    hovermode: 'x unified'
};

const monthlyConfig = {
    responsive: true,
    displayModeBar: false
};

try {
    console.log('üìà Cr√©ation graphique mensuel...');
    Plotly.newPlot('monthly-chart', [monthlyTrace], monthlyLayout, monthlyConfig);
    console.log('‚úÖ Graphique mensuel cr√©√©');
} catch (error) {
    console.error('‚ùå Erreur graphique mensuel:', error);
    document.getElementById('monthly-chart').innerHTML = '<p class="text-red-600 p-4">Erreur de chargement du graphique: ' + error.message + '</p>';
}

// Graphique 2 : R√©partition par poste (camembert)
const repartition = {{ consommation.repartition_postes|safe }};
console.log('ü•ß Donn√©es r√©partition:', repartition);

const labels = [];
const values = [];
const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

const labelMap = {
    'chauffage': 'üî• Chauffage',
    'ecs': 'üöø Eau chaude',
    'electromenager': 'üß∫ √âlectrom√©nager',
    'cuisson': 'üç≥ Cuisson',
    'audiovisuel': 'üì∫ Audiovisuel',
    'eclairage': 'üí° √âclairage'
};

let i = 0;
for (const [poste, data] of Object.entries(repartition)) {
    labels.push(labelMap[poste] || poste);
    values.push(data.kwh);
    i++;
}

const pieTrace = {
    labels: labels,
    values: values,
    type: 'pie',
    marker: {
        colors: colors
    },
    textinfo: 'label+percent',
    textposition: 'outside',
    hovertemplate: '<b>%{label}</b><br>%{value:.0f} kWh<br>%{percent}<extra></extra>'
};

const pieLayout = {
    showlegend: true,
    legend: {
        orientation: 'v',
        x: 1.1,
        y: 0.5
    },
    margin: { t: 20, r: 200, b: 20, l: 20 },
    plot_bgcolor: 'white',
    paper_bgcolor: 'white'
};

const pieConfig = {
    responsive: true,
    displayModeBar: false
};

try {
    console.log('ü•ß Cr√©ation graphique camembert...');
    Plotly.newPlot('pie-chart', [pieTrace], pieLayout, pieConfig);
    console.log('‚úÖ Graphique camembert cr√©√©');
} catch (error) {
    console.error('‚ùå Erreur graphique camembert:', error);
    document.getElementById('pie-chart').innerHTML = '<p class="text-red-600 p-4">Erreur de chargement du graphique: ' + error.message + '</p>';
}

// Responsive
window.addEventListener('resize', function() {
    Plotly.Plots.resize('monthly-chart');
    Plotly.Plots.resize('pie-chart');
});
</script>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    .bg-gradient-to-br {
        background: white !important;
    }
}

/* Animation au chargement */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bg-white {
    animation: fadeIn 0.5s ease-out;
}
</style>

{% endblock %}
