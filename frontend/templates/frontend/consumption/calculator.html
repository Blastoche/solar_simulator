{% extends "base.html" %}
{% load static %}

{% block title %}Calculateur de Consommation - Solar Simulator{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 py-12">
    <div class="max-w-4xl mx-auto px-4">
        
        <!-- En-t√™te -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                üìä Calculateur de Consommation √âlectrique
            </h1>
            <p class="text-lg text-gray-600">
                Estimez votre consommation annuelle en quelques questions
            </p>
        </div>
        
        <!-- S√©lecteur de mode -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex gap-4 justify-center">
                <!-- ‚úÖ MODE RAPIDE (actif par d√©faut) -->
                <button id="mode-rapide-btn" 
                        class="mode-btn active px-6 py-3 rounded-lg font-semibold transition"
                        onclick="selectMode('rapide')">
                    üöÄ Mode Rapide (5 min)
                </button>
                
                <!-- ‚úÖ MODE EXPERT (maintenant activ√© !) -->
                <a href="{% url 'frontend:consumption_calculator_expert' %}"
                   id="mode-expert-btn" 
                   class="mode-btn px-6 py-3 rounded-lg font-semibold transition inline-flex items-center"
                   style="text-decoration: none;">
                    üî¨ Mode Expert (15 min)
                </a>
            </div>
        </div>
        
        <!-- Formulaire -->
        <form id="consumption-form" method="post" action="{% url 'frontend:consumption_calculate' %}" class="bg-white rounded-xl shadow-lg p-8">
            {% csrf_token %}
            
            <input type="hidden" name="mode" id="mode-input" value="rapide">
            
            <!-- Barre de progression -->
            <div class="mb-8">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-semibold text-gray-600">√âtape <span id="current-step">1</span> sur 8</span>
                    <span class="text-sm font-semibold text-purple-600"><span id="progress-pct">13</span>%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-300" style="width: 13%"></div>
                </div>
            </div>
            
            <!-- √âTAPE 1 : Informations Logement -->
            <div class="step active" data-step="1">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">1</span>
                    üè† Votre logement
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Surface habitable (m¬≤) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" name="surface" required min="10" max="1000" value="100"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nombre de personnes <span class="text-red-500">*</span>
                        </label>
                        <input type="number" name="nb_personnes" required min="1" max="15" value="2"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ann√©e de construction
                        </label>
                        
                        <!-- Toggle mode ann√©e/plage -->
                        <div class="flex gap-2 mb-3">
                            <button type="button" class="btn-toggle-year active px-4 py-2 rounded-lg text-sm font-semibold transition" data-mode="plage">
                                Par p√©riode
                            </button>
                            <button type="button" class="btn-toggle-year px-4 py-2 rounded-lg text-sm font-semibold transition" data-mode="annee">
                                Ann√©e exacte
                            </button>
                        </div>
                        
                        <!-- Mode plage (affich√© par d√©faut) -->
                        <select name="annee_construction_plage" id="plage-mode"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="2021">Depuis 2021 (RE2020)</option>
                            <option value="2013">2013-2020 (RT2012)</option>
                            <option value="2005">2005-2012 (RT2005)</option>
                            <option value="1988" selected>1988-2004 (RT1988)</option>
                            <option value="1974">1974-1987 (RT1974)</option>
                            <option value="1900">Avant 1974</option>
                        </select>
                        
                        <!-- Mode ann√©e exacte (cach√© par d√©faut) -->
                        <input type="number" name="annee_construction_exacte" id="annee-mode" 
                               placeholder="Ex: 1995" min="1900" max="2024" style="display:none;"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            DPE (√©tiquette √©nerg√©tique) <span class="text-red-500">*</span>
                        </label>
                        <select name="dpe" required
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="A">A - Tr√®s performant (< 50 kWh/m¬≤/an)</option>
                            <option value="B">B - Performant (50-90 kWh/m¬≤/an)</option>
                            <option value="C">C - Assez performant (91-150 kWh/m¬≤/an)</option>
                            <option value="D" selected>D - Moyen (151-230 kWh/m¬≤/an)</option>
                            <option value="E">E - M√©diocre (231-330 kWh/m¬≤/an)</option>
                            <option value="F">F - √ânergivore (331-450 kWh/m¬≤/an)</option>
                            <option value="G">G - Tr√®s √©nergivore (> 450 kWh/m¬≤/an)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Coordonn√©es (cach√©es, r√©cup√©r√©es du formulaire principal) -->
                <input type="hidden" name="latitude" value="48.8566">
                <input type="hidden" name="longitude" value="2.3522">
            </div>
            
            <!-- √âTAPE 2 : Chauffage -->
            <div class="step" data-step="2">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">2</span>
                    üî• Chauffage
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Type de chauffage principal <span class="text-red-500">*</span>
                        </label>
                        <select name="type_chauffage" required
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="electrique">√âlectrique (convecteurs, radiateurs)</option>
                            <option value="pac">Pompe √† chaleur (PAC)</option>
                            <option value="gaz">Gaz</option>
                            <option value="fioul">Fioul</option>
                            <option value="bois">Bois / Granul√©s</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Temp√©rature de consigne (hiver)
                        </label>
                        <input type="number" name="temperature_consigne" min="15" max="25" value="19" step="0.5"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">üí° Recommand√© : 19¬∞C (1¬∞C de moins = 7% d'√©conomie)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Type de VMC
                        </label>
                        <select name="type_vmc"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="simple_flux">Simple flux</option>
                            <option value="double_flux">Double flux (r√©cup√©ration chaleur)</option>
                            <option value="aucune">Aucune</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- √âTAPE 3 : Eau Chaude Sanitaire -->
            <div class="step" data-step="3">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">3</span>
                    üíß Eau Chaude Sanitaire
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Type de production <span class="text-red-500">*</span>
                        </label>
                        <select name="type_ecs" required
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="ballon_electrique">Ballon √©lectrique (cumulus)</option>
                            <option value="chauffe_eau_instantane">Chauffe-eau instantan√©</option>
                            <option value="thermodynamique">Chauffe-eau thermodynamique</option>
                            <option value="solaire">Chauffe-eau solaire</option>
                            <option value="gaz">Chauffe-eau gaz</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Capacit√© du ballon (litres)
                        </label>
                        <input type="number" name="capacite_ecs" min="50" max="500" value="200"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">üí° Recommandation : 50L/personne</p>
                    </div>
                </div>
            </div>
            
            <!-- √âTAPE 4 : √âlectrom√©nager -->
            <div class="step" data-step="4">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">4</span>
                    üîå √âlectrom√©nager
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            √Çge moyen des appareils
                        </label>
                        <select name="age_appareils"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="recent">R√©cents (< 5 ans) - Classe A++/A+++</option>
                            <option value="moyen" selected>Moyens (5-10 ans) - Classe A/A+</option>
                            <option value="ancien">Anciens (> 10 ans) - Classe B/C</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Type de cuisson principal
                        </label>
                        <select name="type_cuisson"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="induction">Induction</option>
                            <option value="vitroceramique">Vitroc√©ramique</option>
                            <option value="electrique">√âlectrique classique</option>
                            <option value="gaz">Gaz</option>
                            <option value="mixte">Mixte (gaz + √©lectrique)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- √âTAPE 5 : √âclairage -->
            <div class="step" data-step="5">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">5</span>
                    üí° √âclairage
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Type d'√©clairage majoritaire
                        </label>
                        <select name="type_eclairage"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="LED">LED (100% LED)</option>
                            <option value="fluocompactes">Fluocompactes (√©conomiques)</option>
                            <option value="incandescence">Incandescence / Halog√®nes</option>
                            <option value="mixte">Mixte</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- √âTAPE 6 : Usage Audiovisuel -->
            <div class="step" data-step="6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">6</span>
                    üì∫ Usage Audiovisuel
                </h2>
                
                <div class="space-y-4">
                    <p class="text-sm text-gray-600 mb-4">S√©lectionnez votre profil d'usage</p>
                    
                    <label class="usage-card block p-4 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                        <input type="radio" name="usage_audiovisuel" value="faible" class="mr-3">
                        <div class="inline-block">
                            <div class="font-semibold">üì± Usage faible</div>
                            <div class="text-sm text-gray-600">TV occasionnelle, peu d'appareils</div>
                        </div>
                    </label>
                    
                    <label class="usage-card block p-4 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                        <input type="radio" name="usage_audiovisuel" value="courant" checked class="mr-3">
                        <div class="inline-block">
                            <div class="font-semibold">üì∫ Usage courant</div>
                            <div class="text-sm text-gray-600">TV quotidienne, ordinateur, quelques appareils</div>
                        </div>
                    </label>
                    
                    <label class="usage-card block p-4 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                        <input type="radio" name="usage_audiovisuel" value="eleve" class="mr-3">
                        <div class="inline-block">
                            <div class="font-semibold">üéÆ Usage √©lev√©</div>
                            <div class="text-sm text-gray-600">Plusieurs TV, gaming, home cin√©ma</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- √âTAPE 7 : Puissance Compteur -->
            <div class="step" data-step="7">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">7</span>
                    ‚ö° Puissance Compteur
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Puissance souscrite
                        </label>
                        <select name="puissance_compteur"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="3kVA">3 kVA (petit logement)</option>
                            <option value="6kVA" selected>6 kVA (standard)</option>
                            <option value="9kVA">9 kVA (grand logement)</option>
                            <option value="12kVA">12 kVA (tr√®s grand logement)</option>
                            <option value="15kVA">15 kVA+</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- √âTAPE 8 : Type de Contrat -->
            <div class="step" data-step="8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center mr-3">8</span>
                    üìã Type de Contrat
                </h2>
                
                <div class="space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Choisissez votre type de contrat √©lectrique</p>
                    
                    <label class="contract-card block p-4 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                        <input type="radio" name="type_contrat" value="base" checked class="mr-3">
                        <div class="inline-block">
                            <div class="font-semibold">‚ö™ Tarif Base</div>
                            <div class="text-sm text-gray-600">Prix unique 24h/24</div>
                        </div>
                    </label>
                    
                    <label class="contract-card block p-4 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                        <input type="radio" name="type_contrat" value="hphc" class="mr-3">
                        <div class="inline-block">
                            <div class="font-semibold">üåô Heures Pleines / Heures Creuses</div>
                            <div class="text-sm text-gray-600">Prix r√©duit de 22h √† 6h (8h/jour)</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Boutons navigation -->
            <div class="flex justify-between mt-8">
                <button type="button" id="prev-btn" 
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        style="display: none;">
                    ‚Üê Pr√©c√©dent
                </button>
                <button type="button" id="next-btn" 
                        class="ml-auto px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                    Suivant ‚Üí
                </button>
                <button type="submit" id="submit-btn" 
                        class="ml-auto px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition shadow-lg"
                        style="display: none;">
                    üöÄ Calculer ma consommation
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.mode-btn {
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b7280;
}

.mode-btn.active {
    background: linear-gradient(to right, #8b5cf6, #3b82f6);
    color: white;
    border-color: transparent;
}

.mode-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.step {
    display: none;
}

.step.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Toggle ann√©e construction */
.btn-toggle-year {
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b7280;
}

.btn-toggle-year.active {
    background: #8b5cf6;
    color: white;
    border-color: #8b5cf6;
}

/* Cartes usage audiovisuel */
.usage-card {
    border-color: #e5e7eb;
}

.usage-card:has(input:checked) {
    border-color: #8b5cf6;
    background: #f3e8ff;
}

/* Cartes contrat √©lectricit√© */
.contract-card {
    border-color: #e5e7eb;
}

.contract-card:has(input:checked) {
    border-color: #8b5cf6;
    background: #f3e8ff;
}
</style>

<script>
let currentStep = 1;
const totalSteps = 8;

// ‚úÖ NOUVELLE FONCTION : S√©lection mode (Mode Rapide reste sur cette page)
function selectMode(mode) {
    document.getElementById('mode-input').value = mode;
    document.getElementById('mode-rapide-btn').classList.add('active');
}

// Navigation √©tapes
document.getElementById('next-btn').addEventListener('click', () => {
    if (currentStep < totalSteps) {
        currentStep++;
        updateStep();
    }
});

document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentStep > 1) {
        currentStep--;
        updateStep();
    }
});

function updateStep() {
    // Cacher toutes les √©tapes
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Afficher l'√©tape actuelle
    document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
    
    // Mettre √† jour la barre de progression
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('current-step').textContent = currentStep;
    document.getElementById('progress-pct').textContent = Math.round(progress);
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // G√©rer les boutons
    document.getElementById('prev-btn').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('next-btn').style.display = currentStep === totalSteps ? 'none' : 'block';
    document.getElementById('submit-btn').style.display = currentStep === totalSteps ? 'block' : 'none';
    
    // Scroll en haut
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Toggle ann√©e construction
document.querySelectorAll('.btn-toggle-year').forEach(btn => {
    btn.addEventListener('click', function() {
        const mode = this.dataset.mode;
        
        // Mettre √† jour les boutons
        document.querySelectorAll('.btn-toggle-year').forEach(b => {
            b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Afficher/cacher les champs
        if (mode === 'plage') {
            document.getElementById('plage-mode').style.display = 'block';
            document.getElementById('annee-mode').style.display = 'none';
            document.getElementById('annee-mode').value = '';
            document.getElementById('annee-mode').removeAttribute('name');
            document.getElementById('plage-mode').setAttribute('name', 'annee_construction');
        } else {
            document.getElementById('plage-mode').style.display = 'none';
            document.getElementById('annee-mode').style.display = 'block';
            document.getElementById('plage-mode').value = '';
            document.getElementById('plage-mode').removeAttribute('name');
            document.getElementById('annee-mode').setAttribute('name', 'annee_construction');
        }
    });
});

// Initialiser: plage-mode a le name par d√©faut
document.getElementById('plage-mode').setAttribute('name', 'annee_construction');
</script>
{% endblock %}
