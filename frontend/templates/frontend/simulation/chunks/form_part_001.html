{% extends "base.html" %}

{% block title %}Simulation Solaire - Solar Simulator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { height: 400px; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .form-section { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
    
    /* Indicateur d'Ã©tapes */
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 3rem; position: relative; }
    .step-indicator::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; }
    .step { position: relative; z-index: 1; text-align: center; flex: 1; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #e5e7eb; 
                   display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; 
                   font-weight: bold; transition: all 0.3s; }
    .step.active .step-circle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                                border-color: #667eea; transform: scale(1.1); }
    .step.completed .step-circle { background: #10b981; color: white; border-color: #10b981; }
    .step-label { font-size: 0.875rem; color: #6b7280; }
    .step.active .step-label { color: #667eea; font-weight: 600; }
    
    /* Cartes d'objectifs */
    .objectif-card { border: 3px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; cursor: pointer; 
                     transition: all 0.3s; background: white; height: 100%; }
    .objectif-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: #667eea; }
    .objectif-card.selected { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e6efff 100%); 
                             box-shadow: 0 0 0 3px rgba(102,126,234,0.2); }
    .objectif-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; 
                    justify-content: center; font-size: 2rem; margin: 0 auto 1rem; }
    
    /* Configuration optimisÃ©e */
    .config-result { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                    border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; }
    .config-metric { background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 1rem; }
    
    /* Autocomplete */
    #address-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; 
                          border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.5rem 0.5rem; 
                          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-height: 300px; 
                          overflow-y: auto; z-index: 1000; display: none; }
    #address-suggestions.show { display: block; }
    .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; }
    .suggestion-item:hover { background: #f9fafb; }
</style>
{% endblock %}

{% block content %}
<!-- Bandeau profil de consommation -->
{% if request.GET.profil_id %}
<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
    <div class="flex items-center">
        <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div class="ml-3">
            <p class="text-sm font-medium text-blue-800">
                âœ… Votre profil de consommation est bien pris en compte dans cette simulation
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12">
    <div class="container mx-auto px-4">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                â˜€ï¸ Simulation Solaire Intelligente
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Dimensionnement optimal adaptÃ© Ã  vos objectifs
            </p>
        </div>
        
        <!-- Indicateur d'Ã©tapes -->
        <div class="max-w-5xl mx-auto mb-12">
            <div class="step-indicator">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Localisation</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Consommation</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Objectif</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Configuration</div>
                </div>
            </div>
        </div>
        
        <!-- Formulaire -->
        <form id="simulation-form" method="post" action="{% url 'frontend:simulation_create' %}" class="max-w-5xl mx-auto">
            {% csrf_token %}
            
            <!-- ========== Ã‰TAPE 1 : LOCALISATION ========== -->
            <div class="form-section" id="section-1">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">1</span>
                    ðŸ“ OÃ¹ se situe votre projet ?
                </h2>
                
                <!-- Carte -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Cliquez sur la carte ou recherchez votre adresse
                    </label>
                    <div id="map"></div>
                </div>
                
                <!-- Adresse -->
                <div class="mb-6 relative">
                    <label for="adresse-input" class="block text-sm font-semibold text-gray-700 mb-2">
                        ðŸ“ Adresse
                    </label>
                    <input type="text" name="adresse" id="adresse-input"
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500"
                           placeholder="Ex: 10 rue de Rivoli, Paris"
                           autocomplete="off">
                    <div id="address-suggestions"></div>
                </div>
                
                <!-- CoordonnÃ©es -->
                <input type="hidden" name="latitude" id="latitude-input">
                <input type="hidden" name="longitude" id="longitude-input">
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Latitude</div>
                        <div class="text-lg font-bold" id="display-lat">-- (cliquez sur la carte)</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Longitude</div>
                        <div class="text-lg font-bold" id="display-lon">-- (cliquez sur la carte)</div>
                    </div>
                </div>
                
                <button type="button" onclick="nextStep(2)" 
                        class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition transform hover:scale-105 font-semibold text-lg">
                    Continuer <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            
            <!-- ========== Ã‰TAPE 2 : CONSOMMATION ========== -->
            <div class="form-section hidden" id="section-2">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">2</span>
                    âš¡ Quelle est votre consommation Ã©lectrique ?
                </h2>
                
                <div class="space-y-4 mb-6">
                    <!-- Option A : Analyse dÃ©jÃ  faite -->
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition cursor-pointer" 
                         onclick="selectConsoOption('analysee')">
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="conso_option" value="analysee" class="mt-1 mr-3">
                            <div>
                                <div class="font-semibold text-lg">âœ… J'ai dÃ©jÃ  analysÃ© ma consommation</div>
                                <p class="text-sm text-gray-600 mt-1">
                                    Vous avez utilisÃ© notre calculateur ? Vos donnÃ©es sont prÃ©-remplies !
                                </p>
                                <div id="conso-analysee-details" class="hidden mt-3 p-3 bg-green-50 rounded">
                                    <div class="font-semibold">ðŸ“Š Consommation : <span id="conso-value">--</span> kWh/an</div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Option B : Saisie manuelle -->
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition cursor-pointer" 
                         onclick="selectConsoOption('manuelle')">
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="conso_option" value="manuelle" class="mt-1 mr-3">
                            <div class="flex-1">
                                <div class="font-semibold text-lg">âœï¸ Je connais ma consommation</div>
                                <p class="text-sm text-gray-600 mt-1">Saisissez votre consommation annuelle</p>
                                <div id="conso-manuelle-input" class="hidden mt-3">
                                    <input type="number" id="consommation_annuelle" name="consommation_annuelle"
                                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ex: 5000" min="1000" max="50000">
                                    <div class="mt-3 text-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <p class="text-sm text-blue-800 mb-2">
                                            ðŸ’¡ Besoin d'une estimation plus prÃ©cise avec vos appareils ?
                                        </p>
                                        <a href="#" id="detailed-consumption-link" 
                                        class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold">
                                            ðŸ“‹ Remplir le formulaire dÃ©taillÃ© (2 min)
                                        </a>
                                    </div>
