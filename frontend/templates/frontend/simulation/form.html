{% extends "base.html" %}
{% load l10n %}

{% block title %}Simulation Solaire - Solar Simulator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { height: 400px; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .form-section { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
    
    /* Indicateur d'√©tapes */
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 3rem; position: relative; }
    .step-indicator::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; }
    .step { position: relative; z-index: 1; text-align: center; flex: 1; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #e5e7eb; 
                   display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; 
                   font-weight: bold; transition: all 0.3s; }
    .step.active .step-circle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                                border-color: #667eea; transform: scale(1.1); }
    .step.completed .step-circle { background: #10b981; color: white; border-color: #10b981; }
    .step-label { font-size: 0.875rem; color: #6b7280; }
    .step.active .step-label { color: #667eea; font-weight: 600; }
    
    /* Cartes d'objectifs */
    .objectif-card { border: 3px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; cursor: pointer; 
                     transition: all 0.3s; background: white; height: 100%; }
    .objectif-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: #667eea; }
    .objectif-card.selected { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e6efff 100%); 
                             box-shadow: 0 0 0 3px rgba(102,126,234,0.2); }
    .objectif-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; 
                    justify-content: center; font-size: 2rem; margin: 0 auto 1rem; }
    
    /* Configuration optimis√©e */
    .config-result { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                    border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; }
    .config-metric { background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 1rem; }
    
    /* Autocomplete */
    #address-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; 
                          border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.5rem 0.5rem; 
                          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-height: 300px; 
                          overflow-y: auto; z-index: 1000; display: none; }
    #address-suggestions.show { display: block; }
    .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; }
    .suggestion-item:hover { background: #f9fafb; }
</style>
{% endblock %}

{% block content %}
<!-- Bandeau profil de consommation -->
{% if request.GET.profil_id %}
<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
    <div class="flex items-center">
        <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div class="ml-3">
            <p class="text-sm font-medium text-blue-800">
                ‚úÖ Votre profil de consommation est bien pris en compte dans cette simulation
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12">
    <div class="container mx-auto px-4">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                ‚òÄÔ∏è Simulation Solaire Intelligente
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Dimensionnement optimal adapt√© √† vos objectifs
            </p>
        </div>
        
        <!-- Indicateur d'√©tapes -->
        <div class="max-w-5xl mx-auto mb-12">
            <div class="step-indicator">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Localisation</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Consommation</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Objectif</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Configuration</div>
                </div>
            </div>
        </div>
        
        <!-- Formulaire -->
        <form id="simulation-form" method="post" action="{% url 'frontend:simulation_create' %}" class="max-w-5xl mx-auto">
            {% csrf_token %}
            
            <!-- ===== AFFICHAGE DES ERREURS DE VALIDATION ===== -->
            {% if form.errors %}
            <div style="background:#fef2f2; border:3px solid #ef4444; color:#991b1b; padding:1.5rem; border-radius:0.75rem; margin-bottom:2rem; font-size:1rem;">
                <h3 style="font-size:1.25rem; font-weight:bold; margin-bottom:0.75rem;">‚ö†Ô∏è Le formulaire contient des erreurs :</h3>
                <ul style="list-style:disc; padding-left:1.5rem;">
                {% for field, errors in form.errors.items %}
                    <li><strong>{{ field }}</strong> : {{ errors.0 }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if messages %}
            <div style="margin-bottom:2rem;">
                {% for message in messages %}
                <div style="padding:1rem; border-radius:0.5rem; margin-bottom:0.5rem;
                    {% if message.tags == 'error' %}background:#fef2f2; border:2px solid #ef4444; color:#991b1b;
                    {% elif message.tags == 'success' %}background:#f0fdf4; border:2px solid #10b981; color:#065f46;
                    {% else %}background:#eff6ff; border:2px solid #3b82f6; color:#1e40af;{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- ========== √âTAPE 1 : LOCALISATION ========== -->
            <div class="form-section" id="section-1">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">1</span>
                    üìç O√π se situe votre projet ?
                </h2>
                
                <!-- Carte -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Cliquez sur la carte ou recherchez votre adresse
                    </label>
                    <div id="map"></div>
                </div>
                
                <!-- Adresse -->
                <div class="mb-6 relative">
                    <label for="adresse-input" class="block text-sm font-semibold text-gray-700 mb-2">
                        üìç Adresse
                    </label>
                    <input type="text" name="adresse" id="adresse-input"
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500"
                           placeholder="Ex: 10 rue de Rivoli, Paris"
                           autocomplete="off">
                    <div id="address-suggestions"></div>
                </div>
                
                <!-- Coordonn√©es -->
                <input type="hidden" name="latitude" id="latitude-input">
                <input type="hidden" name="longitude" id="longitude-input">
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Latitude</div>
                        <div class="text-lg font-bold" id="display-lat">-- (cliquez sur la carte)</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Longitude</div>
                        <div class="text-lg font-bold" id="display-lon">-- (cliquez sur la carte)</div>
                    </div>
                </div>
                
                <button type="button" onclick="nextStep(2)" 
                        class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition transform hover:scale-105 font-semibold text-lg">
                    Continuer <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            
            <!-- ========== √âTAPE 2 : CONSOMMATION ========== -->
            <div class="form-section hidden" id="section-2">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">2</span>
                    ‚ö° Quelle est votre consommation √©lectrique ?
                </h2>
                
                <div class="space-y-4 mb-6">
                    <!-- Option A : Analyse d√©j√† faite -->
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition cursor-pointer" 
                         onclick="selectConsoOption('analysee')">
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="conso_option" value="analysee" class="mt-1 mr-3">
                            <div>
                                <div class="font-semibold text-lg">‚úÖ J'ai d√©j√† analys√© ma consommation</div>
                                <p class="text-sm text-gray-600 mt-1">
                                    Vous avez utilis√© notre calculateur ? Vos donn√©es sont pr√©-remplies !
                                </p>
                                <div id="conso-analysee-details" class="hidden mt-3 p-3 bg-green-50 rounded">
                                    <div class="font-semibold">üìä Consommation : <span id="conso-value">--</span> kWh/an</div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Option B : Saisie manuelle -->
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition cursor-pointer" 
                         onclick="selectConsoOption('manuelle')">
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="conso_option" value="manuelle" class="mt-1 mr-3">
                            <div class="flex-1">
                                <div class="font-semibold text-lg">‚úçÔ∏è Je connais ma consommation</div>
                                <p class="text-sm text-gray-600 mt-1">Saisissez votre consommation annuelle</p>
                                <div id="conso-manuelle-input" class="hidden mt-3">
                                    <input type="number" id="consommation_annuelle" name="consommation_annuelle"
                                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ex: 5000" min="1000" max="50000">
                                    <p class="text-xs text-gray-500 mt-1">kWh/an (voir sur votre facture EDF)</p>
                                    
                                    <!-- Profil obligatoire -->
                                    <div id="profile-required-box" class="mt-3 p-4 bg-amber-50 rounded-lg border-2 border-amber-400">
                                        <p class="text-sm text-amber-900 mb-3 font-semibold">
                                            ‚ö†Ô∏è Un profil de consommation est n√©cessaire pour lancer la simulation
                                        </p>
                                        <p class="text-xs text-amber-700 mb-3">
                                            Quelques questions rapides sur votre logement et vos appareils pour personnaliser les r√©sultats.
                                        </p>
                                        <a href="#" id="detailed-consumption-link" 
                                           class="inline-flex items-center justify-center w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition text-sm font-bold">
                                            <i class="fas fa-clipboard-list mr-2"></i>
                                            Cr√©er mon profil de consommation (2 min)
                                        </a>
                                    </div>
                                    
                                    <!-- Confirmation quand profil cr√©√© -->
                                    <div id="profile-created-box" class="mt-3 p-4 bg-green-50 rounded-lg border-2 border-green-400 hidden">
                                        <p class="text-sm text-green-800 font-semibold">
                                            ‚úÖ Profil de consommation cr√©√© ‚Äî Vous pouvez continuer
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Option C : Calculateur -->
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition">
                        <div class="flex items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg">‚ùì Je ne connais pas ma consommation</div>
                                <p class="text-sm text-gray-600 mt-1">Choisissez votre calculateur</p>
                                
                                <!-- ===== 2 OPTIONS ===== -->
                                <div class="mt-3 flex flex-wrap gap-2">
                                    <!-- Option Rapide -->
                                    <a href="{% url 'frontend:consumption_calculator' %}" target="_blank"
                                       class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                        </svg>
                                        ‚ö° Rapide (2 min)
                                    </a>
                                    
                                    <!-- Option Expert -->
                                    <a href="{% url 'frontend:consumption_calculator_expert' %}" target="_blank"
                                       class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                                        </svg>
                                        üéØ Expert (5 min)
                                    </a>
                                </div>
                                
                                <p class="text-xs text-gray-500 mt-2">
                                    üí° <strong>Rapide :</strong> Estimation rapide | <strong>Expert :</strong> Analyse d√©taill√©e par appareil
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Champ cach√© pour stocker la consommation -->
                <input type="hidden" id="consommation_finale" name="consommation_finale" value="">
                
                <!-- Boutons de navigation -->
                <div class="mt-8">
                    <button type="button" onclick="nextStep(3)" 
                            class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition transform hover:scale-105 font-semibold text-lg">
                        Continuer vers l'objectif <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                
                <div class="mt-4 text-center">
                    <button type="button" onclick="prevStep(1)" 
                            class="text-gray-600 hover:text-gray-800 font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i> Retour √† la localisation
                    </button>
                </div>
            </div>
            
            <!-- ========== √âTAPE 3 : OBJECTIF ========== -->
            <div class="form-section hidden" id="section-3">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">3</span>
                    üéØ Quel est votre objectif principal ?
                </h2>
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <!-- Rentabilit√© -->
                    <div class="objectif-card" onclick="selectObjectif('rentabilite')" id="obj-rentabilite">
                        <div class="objectif-icon bg-yellow-100">üí∞</div>
                        <h3 class="text-xl font-bold text-center mb-2">RENTABILIT√â</h3>
                        <p class="text-center text-sm text-gray-600 mb-3">ROI optimal (8-10 ans)</p>
                        <ul class="text-sm space-y-1">
                            <li>‚úì Taux d'autoconso : ~70%</li>
                            <li>‚úì Retour sur investissement rapide</li>
                            <li>‚úì Configuration √©quilibr√©e</li>
                        </ul>
                    </div>
                    
                    <!-- Autonomie -->
                    <div class="objectif-card" onclick="selectObjectif('autonomie')" id="obj-autonomie">
                        <div class="objectif-icon bg-blue-100">‚ö°</div>
                        <h3 class="text-xl font-bold text-center mb-2">AUTONOMIE</h3>
                        <p class="text-center text-sm text-gray-600 mb-3">Ind√©pendance maximale</p>
                        <ul class="text-sm space-y-1">
                            <li>‚úì Taux d'autoconso : ~95%</li>
                            <li>‚úì Couverture compl√®te des besoins</li>
                            <li>‚úì Minimum de r√©seau</li>
                        </ul>
                    </div>
                    
                    <!-- √âquilibre -->
                    <div class="objectif-card" onclick="selectObjectif('equilibre')" id="obj-equilibre">
                        <div class="objectif-icon bg-purple-100">‚öñÔ∏è</div>
                        <h3 class="text-xl font-bold text-center mb-2">√âQUILIBRE</h3>
                        <p class="text-center text-sm text-gray-600 mb-3">Meilleur compromis</p>
                        <ul class="text-sm space-y-1">
                            <li>‚úì Taux d'autoconso : ~85%</li>
                            <li>‚úì Bon ROI + bonne autonomie</li>
                            <li>‚úì Recommand√© pour la plupart</li>
                        </ul>
                    </div>
                    
                    <!-- √âcologie -->
                    <div class="objectif-card" onclick="selectObjectif('ecologie')" id="obj-ecologie">
                        <div class="objectif-icon bg-green-100">üåç</div>
                        <h3 class="text-xl font-bold text-center mb-2">√âCOLOGIE</h3>
                        <p class="text-center text-sm text-gray-600 mb-3">Production maximale</p>
                        <ul class="text-sm space-y-1">
                            <li>‚úì Production d'√©nergie verte max</li>
                            <li>‚úì Impact carbone r√©duit</li>
                            <li>‚úì Contribution au r√©seau</li>
                        </ul>
                    </div>
                    
                    <!-- Revente -->
                    <div class="objectif-card col-span-2" onclick="selectObjectif('revente')" id="obj-revente">
                        <div class="objectif-icon bg-red-100">üí∏</div>
                        <h3 class="text-xl font-bold text-center mb-2">REVENTE TOTALE</h3>
                        <p class="text-center text-sm text-gray-600 mb-3">Revenus garantis 20 ans</p>
                        <div class="grid md:grid-cols-2 gap-4 text-sm mt-3">
                            <ul class="space-y-1">
                                <li>‚úì Vente 100% √† EDF OA</li>
                                <li>‚úì Tarif garanti par l'√âtat</li>
                                <li>‚úì Revenus pr√©visibles</li>
                            </ul>
                            <div class="bg-orange-50 p-3 rounded">
                                <p class="text-orange-800"><strong>‚ö†Ô∏è Important :</strong> Pas d'autoconsommation. Vous continuez √† payer votre √©lectricit√© normalement.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="objectif_choisi" name="objectif">
                
                <!-- Option batterie -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="avec_batterie" name="avec_batterie" class="mr-3">
                        <div>
                            <span class="font-semibold">üîã Ajouter une batterie de stockage</span>
                            <p class="text-sm text-gray-600">Optimise l'autoconsommation (Phase 3 - bient√¥t disponible)</p>
                        </div>
                    </label>
                </div>
                
                <div class="flex gap-4">
                    <button type="button" onclick="prevStep(2)" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Retour
                    </button>
                    <button type="button" onclick="calculerConfiguration()" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition">
                        Calculer la configuration optimale <i class="fas fa-calculator ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- ========== √âTAPE 4 : CONFIGURATION ========== -->
            <div class="form-section hidden" id="section-4">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white mr-3">4</span>
                    ‚öôÔ∏è Configuration de votre installation
                </h2>
                
                <!-- Puissance recommand√©e -->
                <div class="config-result mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-center">üí° Puissance recommand√©e</h3>
                    <div class="text-center mb-4">
                        <div class="text-6xl font-bold" id="puissance-recommandee">--.-- kWc</div>
                        <p class="text-sm text-gray-200 mt-2">
                            soit environ <span id="nb-panneaux">--</span> panneaux de 400 Wc
                        </p>
                    </div>
                    
                    <div class="mt-4 p-4 bg-white bg-opacity-20 rounded-lg">
                        <p class="text-sm leading-relaxed" id="explication-config">--</p>
                    </div>
                </div>
                
                <!-- Param√®tres techniques -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="font-bold mb-4">‚öôÔ∏è Param√®tres techniques</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4">
                        <!-- Puissance -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                Puissance <span id="lock-icon">üîí</span>
                            </label>
                            <input type="number" name="puissance_kw" id="puissance_kw" step="0.5" min="1" max="36"
                                   class="w-full px-4 py-3 rounded-lg border border-gray-300" readonly>
                            <p class="text-xs text-gray-500 mt-1">kWc (kilowatt-cr√™te)</p>
                        </div>
                        
                        <!-- Orientation -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">Orientation</label>
                            <select name="orientation" id="id_orientation" 
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300">
                                <option value="S" selected>Sud (optimal)</option>
                                <option value="SE">Sud-Est</option>
                                <option value="SW">Sud-Ouest</option>
                                <option value="E">Est</option>
                                <option value="EW">Est/Ouest (r√©parti)</option>
                                <option value="W">Ouest</option>
                                <option value="N">Nord</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Est/Ouest : panneaux r√©partis de chaque c√¥t√©</p>
                        </div>
                        
                        <!-- Inclinaison -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">Inclinaison</label>
                            <input type="number" name="inclinaison" id="id_inclinaison" value="30" min="0" max="90"
                                   class="w-full px-4 py-3 rounded-lg border border-gray-300">
                            <p class="text-xs text-gray-500 mt-1">degr√©s (30¬∞ optimal en France)</p>
                        </div>
                    </div>
                    
                    <!-- Toggle personnalisation -->
                    <div class="mt-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-perso" onchange="togglePersonnalisation()" class="mr-3">
                            <span class="text-sm">üéõÔ∏è Je veux personnaliser la puissance</span>
                        </label>
                    </div>
                </div>
                
                <!-- Type toiture -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Type de toiture</label>
                    <select name="type_toiture" id="id_type_toiture" 
                            class="w-full px-4 py-3 rounded-lg border border-gray-300">
                        <option value="tuiles">Tuiles</option>
                        <option value="ardoise">Ardoise</option>
                        <option value="zinc">Zinc</option>
                        <option value="beton">B√©ton</option>
                        <option value="tole">T√¥le</option>
                    </select>
                </div>
                
                <!-- Soumission -->
                <div class="flex gap-4">
                    <button type="button" onclick="prevStep(3)" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Retour
                    </button>
                    <button type="submit" id="submit-button"
                            class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:shadow-lg transition text-lg font-bold">
                        üöÄ Lancer la simulation d√©taill√©e
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ===== VARIABLES GLOBALES =====
    let currentStep = 1;
    let map, marker;
    let consoData = null;
    let hasConsumptionProfile = false;  // Flag: un profil a-t-il √©t√© cr√©√© ?
    
    // Donn√©es de pr√©-remplissage depuis consommation
    {% if prefill_data %}
    consoData = {{ prefill_data|safe }};
    hasConsumptionProfile = true;
    console.log('‚úÖ Donn√©es de pr√©-remplissage charg√©es:', consoData);
    {% endif %}
    
    // Profil existant en session ?
    {% if has_consumption_profile %}
    hasConsumptionProfile = true;
    console.log('‚úÖ Profil de consommation existant d√©tect√©');
    {% endif %}
    
    // ===== NAVIGATION ENTRE √âTAPES =====
    function nextStep(step) {
        // Validation √©tape 1
        if (currentStep === 1) {
            if (!document.getElementById('latitude-input').value) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une localisation');
                return;
            }
        }
        
        // Validation √©tape 2 ‚Äî un profil de consommation est OBLIGATOIRE
        if (currentStep === 2) {
            const option = document.querySelector('input[name="conso_option"]:checked');
            if (!option) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une option de consommation');
                return;
            }
            
            if (option.value === 'analysee') {
                if (!consoData || !consoData.consommation_annuelle) {
                    alert('‚ö†Ô∏è Donn√©es de consommation non trouv√©es. Veuillez cr√©er votre profil.');
                    return;
                }
                if (!hasConsumptionProfile) {
                    alert('‚ö†Ô∏è Veuillez d\'abord cr√©er votre profil de consommation.');
                    return;
                }
                document.getElementById('consommation_finale').value = consoData.consommation_annuelle;
                
            } else if (option.value === 'manuelle') {
                // Option manuelle : le profil doit avoir √©t√© cr√©√© via le formulaire
                if (!hasConsumptionProfile) {
                    alert('‚ö†Ô∏è Pour continuer, veuillez cr√©er votre profil de consommation en cliquant sur le bouton ci-dessus.');
                    // Highlight le bouton
                    const link = document.getElementById('detailed-consumption-link');
                    if (link) {
                        link.classList.add('animate-pulse', 'ring-4', 'ring-amber-400');
                        link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
                const input = document.getElementById('consommation_annuelle');
                if (!input || !input.value || input.value < 1000) {
                    alert('‚ö†Ô∏è Veuillez saisir votre consommation (‚â• 1000 kWh/an)');
                    return;
                }
                document.getElementById('consommation_finale').value = input.value;
            }
            
            console.log('‚úÖ Consommation valid√©e:', document.getElementById('consommation_finale').value, 'kWh/an');
        }
        
        // Validation √©tape 3
        if (currentStep === 3) {
            if (!document.getElementById('objectif_choisi').value) {
                alert('‚ö†Ô∏è Veuillez choisir un objectif');
                return;
            }
        }
        
        // Masquer √©tape actuelle
        document.getElementById(`section-${currentStep}`).classList.add('hidden');
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById(`step-${currentStep}`).classList.add('completed');
        
        // Afficher nouvelle √©tape
        currentStep = step;
        document.getElementById(`section-${currentStep}`).classList.remove('hidden');
        document.getElementById(`step-${currentStep}`).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function prevStep(step) {
        document.getElementById(`section-${currentStep}`).classList.add('hidden');
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        
        currentStep = step;
        document.getElementById(`section-${step}`).classList.remove('hidden');
        document.getElementById(`step-${step}`).classList.add('active');
        document.getElementById(`step-${step}`).classList.remove('completed');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // ===== INITIALISATION CARTE LEAFLET =====
    map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    const customIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6);
        updateLocation(lat, lon);
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng, { icon: customIcon }).addTo(map);
        }
    });
    
    function updateLocation(lat, lon, address = '') {
        document.getElementById('latitude-input').value = lat;
        document.getElementById('longitude-input').value = lon;
        document.getElementById('display-lat').textContent = lat + '¬∞';
        document.getElementById('display-lon').textContent = lon + '¬∞';
        if (address) document.getElementById('adresse-input').value = address;
    }
    
    // ===== AUTOCOMPLETE ADRESSE =====
    let searchTimeout;
    const addressInput = document.getElementById('adresse-input');
    const suggestionsDiv = document.getElementById('address-suggestions');

    addressInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 3) {
            suggestionsDiv.classList.remove('show');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=fr&limit=5`)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = '';
                    
                    if (data.length > 0) {
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = item.display_name;
                            div.onclick = () => {
                                const lat = parseFloat(item.lat).toFixed(6);
                                const lon = parseFloat(item.lon).toFixed(6);
                                
                                addressInput.value = item.display_name;
                                updateLocation(lat, lon, item.display_name);
                                map.setView([lat, lon], 13);
                                
                                if (marker) {
                                    marker.setLatLng([lat, lon]);
                                } else {
                                    marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
                                }
                                
                                suggestionsDiv.classList.remove('show');
                            };
                            suggestionsDiv.appendChild(div);
                        });
                        suggestionsDiv.classList.add('show');
                    } else {
                        suggestionsDiv.classList.remove('show');
                    }
                })
                .catch(err => {
                    console.log('Erreur autocomplete:', err);
                    suggestionsDiv.classList.remove('show');
                });
        }, 300);
    });

    // Fermer suggestions si clic ailleurs
    document.addEventListener('click', function(e) {
        if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.classList.remove('show');
        }
    });
    
    // G√©olocalisation
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            map.setView([lat, lon], 13);
            marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
            updateLocation(lat, lon);
        });
    }
    
    // Pr√©-remplissage si donn√©es de consommation
    // ‚úÖ D√âSACTIV√â EN MODE RESTAURATION pour √©viter les conflits
    {% if not restore_mode %}
    if (consoData) {
        updateLocation(consoData.latitude, consoData.longitude, consoData.adresse || '');
        map.setView([consoData.latitude, consoData.longitude], 13);
        marker = L.marker([consoData.latitude, consoData.longitude], { icon: customIcon }).addTo(map);
        
        // Pr√©-s√©lectionner option A
        const radioAnalysee = document.querySelector('input[value="analysee"]');
        const consoDetails = document.getElementById('conso-analysee-details');
        const consoValue = document.getElementById('conso-value');
        const consoFinale = document.getElementById('consommation_finale');
        
        if (radioAnalysee) radioAnalysee.checked = true;
        if (consoDetails) consoDetails.classList.remove('hidden');
        if (consoValue) consoValue.textContent = consoData.consommation_annuelle.toFixed(0);
        if (consoFinale) consoFinale.value = consoData.consommation_annuelle;
        
        // Navigation automatique vers √©tape 2 apr√®s 1 seconde
        setTimeout(() => {
            console.log('‚è© Navigation automatique vers √©tape 2 (donn√©es pr√©-remplies)');
            document.getElementById('section-1').classList.add('hidden');
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-1').classList.add('completed');
            currentStep = 2;
            document.getElementById('section-2').classList.remove('hidden');
            document.getElementById('step-2').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 1000);
    }
    {% endif %}
    
    // ===== S√âLECTION OPTIONS =====
    function selectConsoOption(option) {
        document.querySelectorAll('input[name="conso_option"]').forEach(el => el.checked = false);
        document.querySelector(`input[value="${option}"]`).checked = true;
        
        document.getElementById('conso-analysee-details').classList.add('hidden');
        document.getElementById('conso-manuelle-input').classList.add('hidden');
        
        if (option === 'analysee') {
            document.getElementById('conso-analysee-details').classList.remove('hidden');
            if (consoData) {
                document.getElementById('consommation_finale').value = consoData.consommation_annuelle;
            }
        } else if (option === 'manuelle') {
            document.getElementById('conso-manuelle-input').classList.remove('hidden');
        }
    }
    
    // Mise √† jour conso manuelle
    const consoInput = document.getElementById('consommation_annuelle');
    if (consoInput) {
        consoInput.addEventListener('input', function() {
            document.getElementById('consommation_finale').value = this.value;
        });
    }
    
    function selectObjectif(obj) {
        document.querySelectorAll('.objectif-card').forEach(el => el.classList.remove('selected'));
        document.getElementById(`obj-${obj}`).classList.add('selected');
        document.getElementById('objectif_choisi').value = obj;
    }
    
    // ===== CALCUL CONFIGURATION OPTIMALE =====
    function calculerConfiguration() {
        const conso = parseFloat(document.getElementById('consommation_finale').value);
        const objectif = document.getElementById('objectif_choisi').value;
        const batterie = document.getElementById('avec_batterie').checked;
        const latitude = parseFloat(document.getElementById('latitude-input').value);
        
        if (!conso || !objectif) {
            alert('‚ö†Ô∏è Donn√©es manquantes pour le calcul');
            return;
        }
        
        // Appel AJAX pour calcul
        fetch('{% url "frontend:calculate_optimal_power" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                consommation: conso,
                objectif: objectif,
                batterie: batterie,
                latitude: latitude
            })
        })
        .then(response => response.json())
        .then(data => {
            // Afficher puissance recommand√©e + explication
            document.getElementById('puissance-recommandee').textContent = data.puissance_kw + ' kWc';
            document.getElementById('nb-panneaux').textContent = Math.ceil(data.puissance_kw / 0.4);
            document.getElementById('explication-config').textContent = data.explication;
            
            // Pr√©-remplir formulaire technique
            document.getElementById('puissance_kw').value = data.puissance_kw;
            document.getElementById('id_orientation').value = data.orientation_optimale || 'S';
            document.getElementById('id_inclinaison').value = data.inclinaison_optimale || 30;
            
            // Passer √† l'√©tape 4
            nextStep(4);
        })
        .catch(error => {
            console.error('Erreur calcul:', error);
            alert('Erreur lors du calcul. Veuillez r√©essayer.');
        });
    }
    
    // ===== PERSONNALISATION =====
    function togglePersonnalisation() {
        const input = document.getElementById('puissance_kw');
        const icon = document.getElementById('lock-icon');
        if (document.getElementById('toggle-perso').checked) {
            input.readOnly = false;
            input.classList.add('border-blue-500', 'bg-blue-50');
            icon.textContent = 'üîì';
        } else {
            input.readOnly = true;
            input.classList.remove('border-blue-500', 'bg-blue-50');
            icon.textContent = 'üîí';
        }
    }
    
    // ===== SOUMISSION FORMULAIRE =====
    document.getElementById('simulation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation finale
        if (!document.getElementById('puissance_kw').value) {
            alert('‚ö†Ô∏è Puissance manquante');
            return;
        }
        
        // Soumettre
        document.getElementById('submit-button').disabled = true;
        document.getElementById('submit-button').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Lancement...';
        this.submit();
    });

// üÜï GESTION DU LIEN FORMULAIRE D√âTAILL√â
document.addEventListener('DOMContentLoaded', function() {
    const detailedLink = document.getElementById('detailed-consumption-link');
    
    if (detailedLink) {
        detailedLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            // R√©cup√©rer toutes les donn√©es du formulaire
            const formData = {
                adresse: document.getElementById('adresse-input').value,
                latitude: document.getElementById('latitude-input').value,
                longitude: document.getElementById('longitude-input').value,
                consommation_annuelle: document.getElementById('consommation_annuelle').value || '',
                current_step: 2
            };
            
            // Sauvegarder en sessionStorage
            sessionStorage.setItem('simulation_partial', JSON.stringify(formData));
            console.log('üíæ Donn√©es sauvegard√©es:', formData);
            
            // Rediriger vers le formulaire d√©taill√©
            window.location.href = '/consumption/configure/?return=simulation';
        });
    }
});


// üÜï RESTAURATION DES DONN√âES AU RETOUR
{% if restore_mode %}
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Mode restauration activ√©');
    hasConsumptionProfile = true;  // Un profil existe puisqu'on revient du formulaire
    
    // üÜï REMPLIR LE CHAMP CONSOMMATION DEPUIS LE PROFIL
    {% if consommation_from_profil %}
    var consoValue = parseInt("{{ consommation_from_profil|stringformat:'d' }}");
    document.getElementById('consommation_finale').value = consoValue;
    console.log('‚úÖ Consommation pr√©-remplie: ' + consoValue + ' kWh');
    {% endif %}
    
    // R√©cup√©rer donn√©es de sessionStorage (optionnel)
    const savedData = sessionStorage.getItem('simulation_partial');
    
    setTimeout(function() {
        // ‚úÖ RESTAURER LES DONN√âES SI DISPONIBLES
        if (savedData) {
            const data = JSON.parse(savedData);
            console.log('üì¶ Donn√©es √† restaurer:', data);
            
            // Restaurer les champs
            if (data.adresse) document.getElementById('adresse-input').value = data.adresse;
            if (data.latitude) {
                document.getElementById('latitude-input').value = data.latitude;
                document.getElementById('display-lat').textContent = data.latitude + '¬∞';
            }
            if (data.longitude) {
                document.getElementById('longitude-input').value = data.longitude;
                document.getElementById('display-lon').textContent = data.longitude + '¬∞';
            }
            
            // Carte
            if (data.latitude && data.longitude && map) {
                map.setView([data.latitude, data.longitude], 13);
                if (marker) {
                    marker.setLatLng([data.latitude, data.longitude]);
                } else {
                    const customIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    });
                    marker = L.marker([data.latitude, data.longitude], { icon: customIcon }).addTo(map);
                }
            }
            
            sessionStorage.removeItem('simulation_partial');
        } else {
            console.log('‚ÑπÔ∏è Pas de donn√©es en sessionStorage (normal si retour depuis formulaire de consommation)');
        }
        
        // ‚úÖ TOUJOURS PASSER √Ä L'√âTAPE 3 EN MODE RESTAURATION
        // (que savedData existe ou non)
        
        // Marquer √©tapes 1 et 2 compl√©t√©es
        document.getElementById('step-1').classList.add('completed');
        document.getElementById('step-2').classList.add('completed');
        document.getElementById('section-1').classList.add('hidden');
        document.getElementById('section-2').classList.add('hidden');
        
        // ‚úÖ Pr√©-s√©lectionner l'option "consommation analys√©e"
        const radioAnalysee = document.querySelector('input[value="analysee"]');
        if (radioAnalysee) {
            radioAnalysee.checked = true;
            document.getElementById('conso-analysee-details')?.classList.remove('hidden');
            const consoValueDisplay = document.getElementById('conso-value');
            if (consoValueDisplay && consoValue) {
                consoValueDisplay.textContent = consoValue;
            }
        }
        
        // ‚úÖ Aller √† l'√©tape 3
        currentStep = 3;
        document.getElementById('section-3').classList.remove('hidden');
        document.getElementById('step-3').classList.add('active');
        
        // Montrer la confirmation de profil cr√©√©
        const requiredBox = document.getElementById('profile-required-box');
        const createdBox = document.getElementById('profile-created-box');
        if (requiredBox) requiredBox.classList.add('hidden');
        if (createdBox) createdBox.classList.remove('hidden');
        
        console.log('‚úÖ √âtape 3 affich√©e - Pr√™t √† choisir un objectif');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 500);
});
{% endif %}

</script>
{% endblock %}