{% extends 'base.html' %}
{% load static %}

{% block title %}RÃ©sultat Mode Expert - {{ consommation.consommation_annuelle_totale|floatformat:0 }} kWh/an{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .appareil-card {
        border-left: 4px solid #3b82f6;
        background: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .appareil-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .category-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .badge-refrigeration { background: #dbeafe; color: #1e40af; }
    .badge-lavage { background: #f3e8ff; color: #6b21a8; }
    .badge-audiovisuel { background: #fed7aa; color: #9a3412; }
    .badge-eclairage { background: #fef3c7; color: #92400e; }
    .badge-piscine { background: #99f6e4; color: #115e59; }
    .badge-vehicule { background: #ddd6fe; color: #5b21b6; }
    
    .progress-bar-custom {
        height: 24px;
        background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 12px;
        transition: width 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- En-tÃªte -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <div class="inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-4 py-2 rounded-full mb-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    <span class="font-semibold">MODE EXPERT</span>
                </div>
                <h1 class="text-4xl font-bold text-gray-900">
                    Analyse Experte de Consommation
                </h1>
                <p class="text-gray-600 mt-2">
                    {{ consommation.surface_habitable }}mÂ² â€¢ {{ consommation.nb_personnes }} personne{{ consommation.nb_personnes|pluralize }} â€¢ DPE {{ consommation.dpe }}
                </p>
            </div>
            
            <div class="text-right">
                <div class="text-sm text-gray-500">CalculÃ© le</div>
                <div class="text-lg font-semibold">{{ consommation.created_at|date:"d/m/Y Ã  H:i" }}</div>
            </div>
        </div>
    </div>
    
    <!-- Stats principales -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Consommation totale -->
        <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white text-opacity-90">Consommation annuelle</span>
                <svg class="w-8 h-8 text-white text-opacity-75" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"/>
                </svg>
            </div>
            <div class="text-5xl font-bold">{{ consommation.consommation_annuelle_totale|floatformat:0 }}</div>
            <div class="text-white text-opacity-90 mt-1">kWh/an</div>
        </div>
        
        <!-- CoÃ»t annuel -->
        <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white text-opacity-90">CoÃ»t annuel estimÃ©</span>
                <svg class="w-8 h-8 text-white text-opacity-75" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="text-5xl font-bold">{{ financier.cout_total|floatformat:0 }}</div>
            <div class="text-white text-opacity-90 mt-1">â‚¬/an</div>
        </div>
        
        <!-- Appareils analysÃ©s -->
        <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white text-opacity-90">Appareils analysÃ©s</span>
                <svg class="w-8 h-8 text-white text-opacity-75" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                    <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                    <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                </svg>
            </div>
            <div class="text-5xl font-bold">{{ nb_appareils }}</div>
            <div class="text-white text-opacity-90 mt-1">appareils dÃ©taillÃ©s</div>
        </div>
    </div>
    
    <!-- RÃ©partition par poste - CORRIGÃ‰ -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ðŸ“Š RÃ©partition par poste</h2>
        
        <div class="space-y-4">
            {% for poste, data in consommation.repartition_postes.items %}
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-gray-700 capitalize">{{ poste }}</span>
                    <span class="text-gray-600">{{ data.kwh|floatformat:0 }} kWh/an ({{ data.pourcentage|floatformat:0 }}%)</span>
                </div>
                <div style="width: 100%; background-color: #e5e7eb; border-radius: 12px; height: 24px;">
                    <div style="height: 24px; background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 12px; width: {{ data.pourcentage }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Appareils dÃ©taillÃ©s -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ðŸ”Œ Vos appareils dÃ©taillÃ©s</h2>
        
        {% for categorie, liste_appareils in appareils_par_categorie.items %}
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="category-badge badge-{{ liste_appareils.0.categorie }}">{{ categorie }}</span>
                <span class="text-sm text-gray-500">({{ liste_appareils|length }} appareil{{ liste_appareils|length|pluralize }})</span>
            </h3>
            
            <div class="space-y-2">
                {% for appareil in liste_appareils %}
                <div class="appareil-card">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">{{ appareil.nom_affichage }}</div>
                            {% if appareil.puissance_w %}
                            <div class="text-sm text-gray-600">Puissance: {{ appareil.puissance_w }}W</div>
                            {% endif %}
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600">{{ appareil.consommation_annuelle|floatformat:0 }} kWh/an</div>
                            {% if appareil.cout_annuel %}
                            <div class="text-sm text-gray-600">{{ appareil.cout_annuel|floatformat:0 }}â‚¬/an</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Optimisation HP/HC -->
    {% if optim_hphc and optim_hphc.economie_annuelle > 0 %}
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl shadow-lg p-8 mb-8 border-2 border-blue-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">ðŸ’¡ Optimisation Heures Pleines / Heures Creuses</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">Consommation HC actuelle</div>
                <div class="text-3xl font-bold text-blue-600">{{ optim_hphc.pct_hc_actuel|floatformat:0 }}%</div>
            </div>
            
            <div class="bg-white rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">Optimisation possible</div>
                <div class="text-3xl font-bold text-purple-600">{{ optim_hphc.pct_hc_optimal|floatformat:0 }}%</div>
            </div>
            
            <div class="bg-white rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">Ã‰conomie potentielle</div>
                <div class="text-3xl font-bold text-green-600">{{ optim_hphc.economie_annuelle|floatformat:0 }}â‚¬/an</div>
            </div>
        </div>
        
        <p class="mt-4 text-gray-700">
            ðŸ’¡ En optimisant vos usages (lave-linge, lave-vaisselle, chauffe-eau) pendant les heures creuses, 
            vous pourriez Ã©conomiser jusqu'Ã  {{ optim_hphc.economie_annuelle|floatformat:0 }}â‚¬ par an !
        </p>
    </div>
    {% endif %}
    
    <!-- Projection 10 ans - COÃ›TS ARRONDIS -->
    {% if consommation.projection_10ans and consommation.projection_10ans.annees %}
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ðŸ“ˆ Projection sur 10 ans</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-3 px-4">AnnÃ©e</th>
                        <th class="text-right py-3 px-4">Consommation (kWh)</th>
                        <th class="text-right py-3 px-4">Prix moyen (â‚¬/kWh)</th>
                        <th class="text-right py-3 px-4">CoÃ»t annuel (â‚¬)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for annee_data in consommation.projection_10ans.annees %}
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-4 font-semibold">{{ annee_data.annee }}</td>
                        <td class="text-right py-3 px-4">{{ annee_data.consommation|floatformat:0 }}</td>
                        <td class="text-right py-3 px-4">{{ annee_data.prix_kwh|floatformat:4 }}</td>
                        <!-- CORRIGÃ‰ : CoÃ»ts arrondis -->
                        <td class="text-right py-3 px-4 font-semibold">{{ annee_data.cout|floatformat:0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-700">
                <strong>HypothÃ¨ses :</strong> Inflation Ã©lectricitÃ© +5%/an, AmÃ©lioration efficacitÃ© -1%/an
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- Actions -->
    <div class="flex gap-4 justify-center">
        <a href="{% url 'frontend:consumption_expert_details' consommation.pk %}" 
           class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all">
            ðŸ“‹ DÃ©tails complets
        </a>
        
        <a href="{% url 'frontend:consumption_calculator_expert' %}" 
           class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
            ðŸ”„ Nouvelle analyse
        </a>
    </div>
</div>
<script>
// Nettoyer les noms d'appareils (retirer dÃ©tails techniques)
document.addEventListener('DOMContentLoaded', function() {
    // Pour le tableau "Vos appareils dÃ©taillÃ©s"
    document.querySelectorAll('.appareil-card .font-semibold').forEach(function(el) {
        let nom = el.textContent.trim();
        // Retirer tout aprÃ¨s Ã— ou (
        if (nom.includes('Ã—')) nom = nom.split('Ã—')[0].trim();
        else if (nom.includes('(')) nom = nom.split('(')[0].trim();
        el.textContent = nom;
    });
    
    // Pour le tableau "Liste complÃ¨te des appareils"
    document.querySelectorAll('table td .font-bold').forEach(function(el) {
        let nom = el.textContent.trim();
        if (nom.includes('Ã—')) nom = nom.split('Ã—')[0].trim();
        else if (nom.includes('(')) nom = nom.split('(')[0].trim();
        el.textContent = nom;
    });
});
</script>
{% endblock %}
