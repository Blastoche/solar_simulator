{% extends 'frontend/pdf/base_pdf.html' %}
{% load pdf_filters %}

{% block title %}Rapport Consommation Expert - {{ consommation.created_at|date:"d/m/Y" }}{% endblock %}

{% block content %}

{# ============================================ #}
{# PAGE 1 : PAGE DE COUVERTURE #}
{# ============================================ #}

<div class="header-cover">
    <h1>üìä ANALYSE DE CONSOMMATION √âLECTRIQUE</h1>
    <div class="subtitle">Rapport Mode Expert</div>
    <div class="date">G√©n√©r√© le {{ now|date:"d/m/Y √† H:i" }}</div>
</div>

<div class="no-break">
    <h2>üè† Caract√©ristiques du Logement</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">Surface</div>
            <div class="value">{{ consommation.surface_habitable }}</div>
            <div class="unit">m¬≤</div>
        </div>
        <div class="stat-card">
            <div class="label">Occupants</div>
            <div class="value">{{ consommation.nombre_occupants }}</div>
            <div class="unit">personne{% if consommation.nombre_occupants > 1 %}s{% endif %}</div>
        </div>
        <div class="stat-card">
            <div class="label">DPE</div>
            <div class="value">{{ consommation.classe_dpe }}</div>
            <div class="unit">Classe √©nerg√©tique</div>
        </div>
    </div>
</div>

<div class="no-break">
    <h2>‚ö° Consommation Annuelle Totale</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">Consommation</div>
            <div class="value">{{ consommation.consommation_annuelle_totale|floatformat:0 }}</div>
            <div class="unit">kWh/an</div>
        </div>
        <div class="stat-card">
            <div class="label">Co√ªt estim√©</div>
            <div class="value">{{ financier.cout_total|floatformat:0 }}</div>
            <div class="unit">‚Ç¨/an</div>
        </div>
        <div class="stat-card">
            <div class="label">Prix moyen kWh</div>
            <div class="value">{{ financier.prix_moyen_kwh|floatformat:3 }}</div>
            <div class="unit">‚Ç¨/kWh</div>
        </div>
    </div>
</div>

<div class="page-break"></div>

{# ============================================ #}
{# PAGE 2 : R√âPARTITION PAR CAT√âGORIE #}
{# ============================================ #}

<h2>üìà R√©partition de la Consommation</h2>

<table>
    <thead>
        <tr>
            <th>Cat√©gorie</th>
            <th class="text-right">Consommation (kWh/an)</th>
            <th class="text-right">Part (%)</th>
            <th class="text-right">Co√ªt (‚Ç¨/an)</th>
        </tr>
    </thead>
    <tbody>
        {% for cat, details in appareils_par_categorie.items %}
        {% with total_cat=details|sum_consommation %}
        <tr>
            <td><strong>{{ cat }}</strong></td>
            <td class="text-right">{{ total_cat|floatformat:0 }}</td>
            <td class="text-right">{{ total_cat|percentage:consommation.consommation_annuelle_totale|floatformat:1 }}%</td>
            <td class="text-right">{{ total_cat|multiply:financier.prix_moyen_kwh|floatformat:2 }}</td>
        </tr>
        {% endwith %}
        {% endfor %}
        <tr style="background: #e5e7eb; font-weight: bold;">
            <td>TOTAL</td>
            <td class="text-right">{{ consommation.consommation_annuelle_totale|floatformat:0 }}</td>
            <td class="text-right">100%</td>
            <td class="text-right">{{ financier.cout_total|floatformat:2 }}</td>
        </tr>
    </tbody>
</table>

<div class="info-box">
    <div class="info-box-title">üí° Comparaison avec la moyenne nationale</div>
    <p>Votre consommation : <strong>{{ consommation.consommation_annuelle_totale|floatformat:0 }} kWh/an</strong></p>
    <p>Moyenne nationale (logement similaire) : <strong>~12 000 kWh/an</strong></p>
    {% if consommation.consommation_annuelle_totale > 12000 %}
    <p><span class="badge badge-warning">Consommation sup√©rieure √† la moyenne (+{{ consommation.consommation_annuelle_totale|subtract:12000|floatformat:0 }} kWh/an)</span></p>
    {% else %}
    <p><span class="badge badge-success">Consommation inf√©rieure √† la moyenne (-{{ 12000|subtract:consommation.consommation_annuelle_totale|floatformat:0 }} kWh/an)</span></p>
    {% endif %}
</div>

<div class="page-break"></div>

{# ============================================ #}
{# PAGE 3 : D√âTAIL DES APPAREILS #}
{# ============================================ #}

<h2>üîå D√©tail des Appareils</h2>

<p>Liste compl√®te des {{ nb_appareils }} appareil{% if nb_appareils > 1 %}s{% endif %} saisis, class√©s par consommation d√©croissante.</p>

<table>
    <thead>
        <tr>
            <th>Appareil</th>
            <th>Cat√©gorie</th>
            <th class="text-right">Puissance</th>
            <th class="text-right">Usage</th>
            <th class="text-right">Conso (kWh/an)</th>
            <th class="text-right">Co√ªt (‚Ç¨/an)</th>
        </tr>
    </thead>
    <tbody>
        {% for appareil in appareils %}
        <tr>
            <td>{{ appareil.nom }}</td>
            <td><span class="badge badge-info">{{ appareil.get_categorie_display }}</span></td>
            <td class="text-right">{{ appareil.puissance_w }} W</td>
            <td class="text-right">{{ appareil.heures_jour }}h/j</td>
            <td class="text-right"><strong>{{ appareil.consommation_annuelle|floatformat:0 }}</strong></td>
            <td class="text-right">{{ appareil.consommation_annuelle|multiply:financier.prix_moyen_kwh|floatformat:2 }} ‚Ç¨</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="info-box warning">
    <div class="info-box-title">üîù Top 3 des appareils les plus gourmands</div>
    <ol>
        {% for appareil in appareils|slice:":3" %}
        <li><strong>{{ appareil.nom }}</strong> : {{ appareil.consommation_annuelle|floatformat:0 }} kWh/an ({{ appareil.consommation_annuelle|multiply:financier.prix_moyen_kwh|floatformat:2 }} ‚Ç¨/an)</li>
        {% endfor %}
    </ol>
</div>

<div class="page-break"></div>

{# ============================================ #}
{# PAGE 4 : OPTIMISATION HP/HC #}
{# ============================================ #}

<h2>üí∞ Optimisation Heures Pleines / Heures Creuses</h2>

{% if optim_hphc %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">√âconomie annuelle potentielle</div>
        <div class="value">{{ optim_hphc.economie_annuelle|floatformat:0 }}</div>
        <div class="unit">‚Ç¨/an</div>
    </div>
    <div class="stat-card">
        <div class="label">Consommation HC optimis√©e</div>
        <div class="value">{{ optim_hphc.conso_hc_optimisee|floatformat:0 }}</div>
        <div class="unit">kWh/an</div>
    </div>
    <div class="stat-card">
        <div class="label">Taux HC</div>
        <div class="value">{{ optim_hphc.taux_hc|floatformat:0 }}</div>
        <div class="unit">%</div>
    </div>
</div>

<h3>Recommandations personnalis√©es</h3>
<ul class="custom-list">
    <li>Programmer le chauffe-eau en heures creuses (22h-6h)</li>
    <li>Lancer le lave-linge et lave-vaisselle apr√®s 22h</li>
    <li>Utiliser un programmateur pour les appareils √©lectrom√©nagers</li>
    <li>Privil√©gier la recharge du v√©hicule √©lectrique en heures creuses</li>
</ul>

{% else %}

<div class="info-box">
    <p>Aucune optimisation HP/HC n'a √©t√© calcul√©e pour ce rapport.</p>
</div>

{% endif %}

<div class="page-break"></div>

{# ============================================ #}
{# PAGE 5 : PROJECTION 10 ANS - VERSION CORRIG√âE #}
{# ============================================ #}

<h2>üìä Projection sur 10 ans</h2>

<p>√âvolution du co√ªt de l'√©lectricit√© avec une inflation estim√©e √† <strong>3% par an</strong>.</p>

<table>
    <thead>
        <tr>
            <th>Ann√©e</th>
            <th class="text-right">Prix kWh (‚Ç¨)</th>
            <th class="text-right">Co√ªt annuel (‚Ç¨)</th>
            <th class="text-right">Cumul (‚Ç¨)</th>
        </tr>
    </thead>
    <tbody>
        {% for annee in projection_10ans %}
        <tr>
            <td>{{ annee.annee }}</td>
            <td class="text-right">{{ annee.prix_kwh|floatformat:3 }}</td>
            <td class="text-right">{{ annee.cout_annuel|floatformat:0 }}</td>
            <td class="text-right"><strong>{{ annee.cumul|floatformat:0 }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% with last_projection=projection_10ans|last %}
<div class="info-box success">
    <div class="info-box-title">üí° Conseil d'installation solaire</div>
    <p>Sur 10 ans, vous d√©penserez environ <strong>{{ last_projection.cumul|floatformat:0 }} ‚Ç¨</strong> en √©lectricit√©.</p>
    <p>Une installation solaire pourrait r√©duire cette facture de <strong>40 √† 70%</strong> selon votre configuration.</p>
    <p>‚Üí Rendez-vous dans la section "Simulation Solaire" pour calculer votre potentiel d'√©conomies ! ‚òÄÔ∏è</p>
</div>
{% endwith %}

{# Footer #}
<div class="footer">
    <p>Rapport g√©n√©r√© par Solar Simulator ‚Ä¢ www.solar-simulator.fr ‚Ä¢ Contact: contact@solar-simulator.fr</p>
    <p>Les donn√©es pr√©sent√©es sont des estimations bas√©es sur vos saisies. Les co√ªts r√©els peuvent varier.</p>
</div>

{% endblock %}